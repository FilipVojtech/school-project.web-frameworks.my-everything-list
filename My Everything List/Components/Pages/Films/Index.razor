@page "/films"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,User")]

@inject NavigationManager Navigation
@inject IDbContextFactory<MyEverythingListContext> DbFactory
@inject IUserService User

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using My_Everything_List.Data
@using My_Everything_List.Models
@using My_Everything_List.Services.UserService

<div class="container-fluid d-flex justify-content-between mb-3">
    <h3>Films</h3>
    <SearchMovieModal ButtonTitle="Add Film" OnItemSelected="OnItemSelected"/>
</div>

@foreach (var film in _films)
{
    <FilmItem
        Id="film.Id"
        Title="@film.Title"
        Description="@film.Description"
        Genres="@film.Genres"
        Image="@film.Image"
        ReleaseDate="@film.ReleaseDate"
        OnClick='() => Navigation.NavigateTo($"/films/film/{film.Id}")'
    />
}

@code {
    private List<Film> _films = [];
    private User _currentUser;

    protected override async Task OnInitializedAsync()
    {
        var user = await User.GetUser();

        if (user is null) Navigation.NavigateTo("/");
        else _currentUser = user;

        await using (var context = await DbFactory.CreateDbContextAsync())
        {
            _films = context.User
                .Include(u => u.SavedFilms)
                .First(u => u == _currentUser).SavedFilms.ToList();
        }

        await base.OnInitializedAsync();
    }

    private void OnItemSelected(object? sender, Film film)
    {
        // TODO: Move logic to FilmService
        using var context = DbFactory.CreateDbContext();
        var filmInDb = context.Film.FirstOrDefault(f => f == film);

        if (filmInDb is null)
        {
            context.User.First(u => u == _currentUser).SavedFilms.Add(film);
            context.SaveChanges();

            _films.Add(film);
            StateHasChanged();
        }
        else if (!_films.Contains(filmInDb))
        {
            context.User.First(u => u == _currentUser).SavedFilms.Add(filmInDb);
            context.SaveChanges();

            _films.Add(film);
            StateHasChanged();
        }
    }

}
